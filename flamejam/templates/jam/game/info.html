{% set jam = game.jam %}
{% extends "jam/base.html" %}
{% from "_formhelpers.html" import form_errors %}

{% block title %}{{ game.jam.title }} » {{ game.title }}{% endblock %}

{% block content %}

<h1>
    {{ game.title }}

    <div class="pull-right">
        {% set rating = game.ratings.filter_by(user_id = current_user.get_id()).first() %}

        {% if current_user.is_authenticated() and current_user.inTeam(game.team) %}
            <a href="{{ url_for('edit_game', jam_slug = game.jam.slug, game_slug = game.slug) }}" class="btn btn-primary btn-normal pull-right">Edit game</a>
        {% elif current_user.is_authenticated() and jam.getStatus().code == 4 and not rating %}
            <a href="{{ url_for('rate_game', jam_slug = jam.slug, game_slug = game.slug) }}" class="btn btn-primary">Rate Game</a>
        {% endif %}
    </div>
</h1>

<div class="row-fluid">
    <div class="span4">
        <h2>Details</h2>
        <table class="details">
            <tr><th>Team</th><td>
                {{ game.team.name }} <a href="{{ game.team.url() }}">show »</a>
                </td></tr>

            <tr><th>Jam</th><td>{{ game.jam.getLink() }}</td></tr>

            <tr><th>Submitted</th><td>{{ game.created | humantime }}</td></tr>
        </table>
    </div>
    <div class="span4">
        <h2>Description</h2>
        {{ (game.description or "*This game has no description.*") | markdown }}

        {% if game.technology %}
            <h2>Technology used</h2>
            {{ game.technology | markdown }}
        {% endif %}
    </div>
    <div class="span4">
        <h2>Download</h2>
        {% if game.packages.count() %}
            {% for package in game.packages %}
                {{ package.getLink() }}
            {% endfor %}
        {% else %}
            <p>There are no packages available yet.</p>
            {% if current_user.is_authenticated() and current_user in game.team.members %}
                <a href="{{ url_for('edit_game', jam_slug = game.jam.slug, game_slug = game.slug) }}" class="btn btn-mini">Upload a package</a>
            {% endif %}
        {% endif %}
    </div>
</div>

<div class="row-fluid">
    <div class="span8">
        {% if game.screenshots.count() %}
        <h2>Screenshots <small>Click a screenshot to zoom</small></h2>
        <ul class="screenshots">
        {% for screenshot in game.screenshotsOrdered %}
            <li>
                <a href="{{ screenshot.url }}" target="_blank" title="{{ screenshot.caption }}" class="screenshot">
                <div class="image"><img src="{{ screenshot.url }}" alt="{{ screenshot.caption }}" /></div>
                </a>
            </li>
        {% endfor %}
        </ul>
        {% endif %}

        {% set status = game.jam.getStatus().code %}
        {% if status >= 4 %}
            {% set rating = game.ratings.filter_by(user_id = current_user.get_id()).first() %}
            {% set categories = game.ratingCategories + ["overall"] %}
            {% set cols = (categories | length) + 2 %}

            <h2>Feedback</h2>

            {% if status == 4 %}
                <p class="alert alert-info">The voting for this jam is not over, so other people's ratings are hidden.</p>
            {% endif %}

            <table class="ratings tabular">
                <tr>
                    <th>User</th>
                    {% for c in categories %}
                        <th class="score"><span class="icon-16 icon-16-{{ c }}" title="{{ c }}"></span></th>
                    {% endfor %}
                    <th>Notes</th>
                </tr>

                {% if status == 5 %}
                    <tr class="average">
                        <td>Average</td>
                        {% for c in categories %}
                            <td class="score">{{ "%.2f" % game.feedbackAverage(c) }}</td>
                        {% endfor %}
                        <td></td>
                    </tr>

                    {% for rating in game.ratings %}
                        <tr>
                            <td>{{ rating.user.getLink() }}</td>
                            {% for c in categories %}
                                <td class="score">{{ rating.get(c) }}</td>
                            {% endfor %}
                            <td>{{ rating.text or "&mdash;" | safe }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    {% if rating %}
                        <tr>
                            <td>{{ rating.user.getLink() }}</td>
                            {% for c in categories %}
                                <td class="score">{{ rating.get(c) }}</td>
                            {% endfor %}
                            <td>{{ rating.text or "&mdash;" | safe }}</td>
                        </tr>
                        <tr><td colspan="{{ cols }}" style="text-align: center;"><a href="{{ url_for('rate_game', jam_slug = jam.slug, game_slug = game.slug) }}" class="btn btn-small">Edit my Rating</a></td></tr>
                    {% elif current_user.is_authenticated() %}
                        <tr><td colspan="{{ cols }}" style="text-align: center;"><a href="{{ url_for('rate_game', jam_slug = jam.slug, game_slug = game.slug) }}" class="btn btn-small">Rate Game</a></td></tr>
                    {% else %}
                        <tr><td colspan="{{ cols }}" style="text-align: center;">Please
                            <a href="{{ url_for('login') }}">login or register</a>
                            to vote on games.</td></tr>
                    {% endif %}
                {% endif %}
            </table>
        {% endif %}
    </div>
    <div class="span4">
        <h2>Comments</h2>
        {% if game.comments.all() %}
        <p>
        <ul class="comments">
        {% for comment in game.comments %}
            <li>
                <div class="icon">
                    <a href="{{ comment.user.url() }}">
                        <img src="{{ comment.user.getAvatar(32) }}" width="32" height="32"/>
                    </a>
                </div>

                <div class="meta">
                    <a class="author" href="{{ comment.user.url() }}">{{ comment.user.username }}</a>
                    (<span class="posted" title="{{ comment.posted | formattime }}">{{ comment.posted | humantime }}</span>)
                </div>
                <div class="text markdown">
                    {{ (comment.text) | markdown }}
                </div>
            </li>
        {% endfor %}
        </ul>
        </p>
        {% else %}
        <p>No comments yet.</p>
        {% endif %}

        {% if current_user.is_authenticated() %}
            <form action="#TODO:new_comment" method="POST">
                    {{ form_errors(form) }}
                    {{ form.hidden_tag() }}
                    {{ form.text(class="comment", rows = 4) }}
                    <!-- <p>Please don't use the comments to judge the work before the voting period is over.
                    This shall allow everyone to rate this game freely and unbiased.</p>
                    <b>Parsed with markdown.</b> -->
                <p style="text-align: right;">
                    <input type="submit" value="Post comment" class="btn btn-primary">
                </p>
            </div>
            </form>
        {% else %}
            <a href="{{ url_for('login', next = request.url) }}">Log in or register</a> to post a comment.
        {% endif %}
    </div>
</div>
{% endblock %}
